{% extends 'index.html' %}
{% load static %} <!-- ¡Esta línea es crucial! -->

{% block extra_css %}
<link rel="stylesheet" href="{% static 'index.css' %}">
{% endblock %}

{% block extra_js %}
<!-- jQuery DEBE estar primero -->

<script>
    // Espera a que jQuery esté completamente cargado
    document.addEventListener('DOMContentLoaded', function () {
        // Verifica que jQuery esté disponible
        if (window.jQuery) {
            console.log("jQuery cargado correctamente");

            $(document).ready(function () {
                console.log("Documento listo, jQuery funcionando");
                cargarTablaPDFs(); // Nota: Corregí el nombre de la función (de Table a Tabla)
            });
        } else {
            console.error("jQuery NO está cargado");
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="table-toolbar">
    <div class="search-container">
        <input type="text" placeholder="Buscar..." class="search-input" id="searchInput">
        <button class="search-button">
            <ion-icon name="search-outline"></ion-icon>
        </button>
    </div>
    <button class="add-new-button" onclick="openModal()">
        <ion-icon name="add-outline"></ion-icon>
        Agregar
    </button>
</div>

<!-- Modal para registrar PDFs -->
<div id="pdfModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Registrar Nuevo PDF</h2>
        <form id="pdfForm">
            <div class="form-columns">
                <div class="form-left">
                    <div class="form-group">
                        <label for="Numerodecaso">Número de Caso/Expediente:</label>
                        <input type="text" id="Numerodecaso" required>
                    </div>
                    <div class="form-group">
                        <label for="titulo">Título</label>
                        <input type="text" id="titulo" required>
                    </div>
                    <div class="form-group">
                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" required>
                    </div>
                </div>

                <div class="form-right">
                    <div class="form-group">
                        <label for="tipoDocumento">Tipo de documento:</label>
                        <select id="tipoDocumento" name="tipoDocumento" required onchange="toggleOtherDocument()">
                            <option value="">-- Seleccione un tipo --</option>
                            <option value="demanda">Demanda</option>
                            <option value="contrato">Contrato</option>
                            <option value="recurso">Recurso</option>
                            <option value="sentencia">Sentencia</option>
                            <option value="escritura_publica">Escritura Pública</option>
                            <option value="testamento">Testamento</option>
                            <option value="poder_notarial">Poder Notarial</option>
                            <option value="dictamen">Dictamen Jurídico</option>
                            <option value="otro">Otro...</option>
                        </select>
                        <div id="otherDocumentContainer" class="other-document-container">
                            <label for="otherDocument">Especificar tipo de documento:</label>
                            <input type="text" id="otherDocument">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="jurisdiccion">Jurisdicción:</label>
                        <select id="jurisdiccion" name="Jurisdiccion" required>
                            <option value="">-- Seleccione una jurisdicción --</option>
                            <option value="local">Local</option>
                            <option value="nacional">Nacional</option>
                            <option value="internacional">Internacional</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pdfFile">Archivo PDF:</label>
                        <input type="file" id="pdfFile" accept=".pdf" required>
                    </div>
                </div>
            </div>
            <button type="button" class="submit-button" onclick="savePDF()">Guardar</button>
        </form>
    </div>
</div>

<!-- Tabla de registros -->
<div class="members-table">
    <table id="pdfTable">
        <thead>
            <tr>
                <th>Título</th>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr>
                <td colspan="5">No hay archivos registrados</td>
            </tr>
        </tbody>
    </table>
</div>
<!-- Modal para el chat de consultas -->
<div id="chatModal" class="modal">
    <div class="modal-content">
        <div class="chat-header" id="chatHeader">
            <h3 id="pdfTitle">Consulta sobre PDF</h3>
            <div class="modal-controls">
                <button class="modal-control-btn" onclick="toggleFullscreen()">
                    <ion-icon name="expand-outline"></ion-icon>
                </button>
                <button class="modal-control-btn" onclick="minimizeChat()">
                    <ion-icon name="remove-outline"></ion-icon>
                </button>
                <button class="modal-control-btn" onclick="closeChatModal()">
                    <ion-icon name="close-outline"></ion-icon>
                </button>
            </div>
        </div>
        <div class="chat-container" id="chatContainer">
            <!-- Mensajes aparecerán aquí -->
        </div>
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="userQuestion" placeholder="Escribe tu mensaje..." autocomplete="off">
                <button class="send-button" onclick="sendQuestion()">
                    <ion-icon name="send"></ion-icon>
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Variables globales para el chat
    let currentPdfId = null;
    let currentPdfTitle = '';
    let isDragging = false;
    let offsetX, offsetY;
    let originalWidth, originalHeight, originalX, originalY;
    let isFullscreen = false;
        function initDragAndResize() {
        const modal = document.getElementById('chatModal');
        const modalContent = document.getElementById('chatModal').querySelector(".modal-content");
        const header = document.getElementById('chatHeader');
        modal.style.display="block";
        modalContent.style.display="block";
        // Arrastrar
        header.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
        
        // Redimensionar
        modal.addEventListener('mousedown', startResize);
    }
    
    // Funciones para arrastrar
    function startDrag(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'ION-ICON') return;
        
        const modal = document.getElementById('chatModal');
        isDragging = true;
        offsetX = e.clientX - modal.getBoundingClientRect().left;
        offsetY = e.clientY - modal.getBoundingClientRect().top;
        modal.style.cursor = 'grabbing';
    }
    
    function drag(e) {
        if (!isDragging) return;
        
        const modal = document.getElementById('chatModal');
        modal.style.left = (e.clientX - offsetX) + 'px';
        modal.style.top = (e.clientY - offsetY) + 'px';
        modal.style.transform = 'none';
    }
    
    function stopDrag() {
        isDragging = false;
        const modal = document.getElementById('chatModal');
        modal.style.cursor = 'default';
    }
    
    // Funciones para redimensionar
    function startResize(e) {
        const modal = document.getElementById('chatModal');
        const rect = modal.getBoundingClientRect();
        
        // Verificar si el clic está cerca de la esquina inferior derecha
        if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) {
            e.preventDefault();
            isDragging = true;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        }
    }
    
    function resize(e) {
        const modal = document.getElementById('chatModal');
        const newWidth = e.clientX - modal.getBoundingClientRect().left;
        const newHeight = e.clientY - modal.getBoundingClientRect().top;
        
        if (newWidth > 300) modal.style.width = newWidth + 'px';
        if (newHeight > 200) modal.style.height = newHeight + 'px';
    }
    
    function stopResize() {
        isDragging = false;
        document.removeEventListener('mousemove', resize);
    }
    // Función para abrir el modal de chat
    function openChatModal(pdfId, title) {
        console.log("KJSDHASJKHDJLASHDSADJ");
        currentPdfId = pdfId;
        currentPdfTitle = title;
        const modal = document.getElementById('chatModal');
        
        // Restablecer posición y tamaño si no es la primera vez
        if (!modal.style.left || !modal.style.top) {
            modal.style.left = '50%';
            modal.style.top = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
        }
        
        document.getElementById('pdfTitle').textContent = title;
        modal.style.display = 'block';
        document.getElementById('chatContainer').innerHTML = '';
        document.getElementById('userQuestion').focus();
        
        // Inicializar eventos de arrastre y redimensionamiento
        initDragAndResize();
    }

    // Función para cerrar el modal de chat
    function closeChatModal() {
        document.getElementById('chatModal').style.display = 'none';
        currentPdfId = null;
        currentPdfTitle = '';
    }

    // Función para enviar pregunta
    function sendQuestion() {
        const questionInput = document.getElementById('userQuestion');
        const question = questionInput.value.trim();

        if (!question || !currentPdfId) return;

        // Añadir pregunta del usuario al chat
        addMessageToChat(question, 'user');
        questionInput.value = '';

        // Mostrar indicador de "escribiendo..."
        const typingIndicator = showTypingIndicator();

        // Enviar pregunta al backend
        fetch('/consultar-pdf/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                pdf_id: currentPdfId,
                question: question
            })
        })
            .then(response => response.json())
            .then(data => {
                // Eliminar indicador de "escribiendo..."
                removeTypingIndicator();

                if (data.answer) {
                    addMessageToChat(data.answer, 'bot');
                } else {
                    addMessageToChat("Lo siento, no pude obtener una respuesta.", 'bot');
                }
            })
            .catch(error => {
                removeTypingIndicator();
                addMessageToChat("Error al conectar con el servidor.", 'bot');
                console.error('Error:', error);
            });
    }

    // Función para añadir mensajes al chat con estilo Messenger
    function addMessageToChat(message, sender) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');

        // Formatear la hora actual
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        messageDiv.className = `chat-message ${sender}-message`;

        // Contenido del mensaje con hora
        messageDiv.innerHTML = `
        <div class="message-content">${message}</div>
        <div class="message-time">${timeString}</div>
    `;

        chatContainer.appendChild(messageDiv);

        // Auto-scroll al último mensaje
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Efecto de "escribiendo..." para respuestas del bot
        if (sender === 'user') {
            showTypingIndicator();
        }
    }

    // Función para mostrar indicador de "escribiendo..."
    function showTypingIndicator() {
        const chatContainer = document.getElementById('chatContainer');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chat-message bot-message typing-indicator';
        typingDiv.innerHTML = `
        <div class="message-content">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    `;
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return typingDiv;
    }

    // Función para eliminar el indicador de "escribiendo..."
    function removeTypingIndicator() {
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    // Función para obtener el token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
     // Función para minimizar el chat
    function minimizeChat() {
        const modal = document.getElementById('chatModal');
        if (modal.style.height === '40px') {
            // Restaurar tamaño
            modal.style.height = originalHeight || '500px';
            modal.style.width = originalWidth || '400px';
            document.querySelector('.chat-container').style.display = 'flex';
            document.querySelector('.chat-input-container').style.display = 'block';
        } else {
            // Guardar tamaño actual y minimizar
            originalHeight = modal.style.height;
            originalWidth = modal.style.width;
            modal.style.height = '40px';
            modal.style.width = '300px';
            document.querySelector('.chat-container').style.display = 'none';
            document.querySelector('.chat-input-container').style.display = 'none';
        }
    }
    
    // Función para alternar pantalla completa
    function toggleFullscreen() {
        const modal = document.getElementById('chatModal');
        if (isFullscreen) {
            // Salir de pantalla completa
            modal.classList.remove('fullscreen');
            modal.style.width = originalWidth || '400px';
            modal.style.height = originalHeight || '500px';
            modal.style.left = originalX || '50%';
            modal.style.top = originalY || '50%';
            modal.style.transform = originalX ? 'none' : 'translate(-50%, -50%)';
        } else {
            // Entrar en pantalla completa
            originalWidth = modal.style.width;
            originalHeight = modal.style.height;
            originalX = modal.style.left;
            originalY = modal.style.top;
            modal.classList.add('fullscreen');
            modal.style.transform = 'none';
        }
        isFullscreen = !isFullscreen;
    }
    // Permitir enviar pregunta con Enter
    document.getElementById('userQuestion').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendQuestion();
        }
    });
    // Funciones JavaScript
    function openModal() {
        document.getElementById('pdfModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('pdfModal').style.display = 'none';
        document.getElementById('pdfForm').reset();
        document.getElementById('otherDocumentContainer').style.display = 'none';
    }

    function toggleOtherDocument() {
        const tipoDocumento = document.getElementById('tipoDocumento').value;
        const otherDocumentContainer = document.getElementById('otherDocumentContainer');

        if (tipoDocumento === 'otro') {
            otherDocumentContainer.style.display = 'block';
        } else {
            otherDocumentContainer.style.display = 'none';
        }
    }

    function savePDF() {
        const formData = new FormData();
        formData.append('numero_caso', document.getElementById('Numerodecaso').value);
        formData.append('titulo', document.getElementById('titulo').value);
        formData.append('fecha', document.getElementById('fecha').value);

        const tipoDocumento = document.getElementById('tipoDocumento').value;
        const otherDocument = document.getElementById('otherDocument').value;
        const tipoDocumentoFinal = tipoDocumento === 'otro' ? otherDocument : tipoDocumento;
        formData.append('tipo_documento', tipoDocumentoFinal);

        formData.append('jurisdiccion', document.getElementById('jurisdiccion').value);
        formData.append('archivo_pdf', document.getElementById('pdfFile').files[0]);

        fetch('/guardar-pdf/', {
            method: 'POST',
            body: formData,
            headers: {
                //'X-CSRFToken': getCookie('csrftoken')  // Si quieres manejar CSRF, aunque @csrf_exempt lo omite.
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                } else {
                    alert(data.mensaje);
                    // Aquí puedes agregar el registro a la tabla o recargar la lista
                    closeModal();
                }
            })
            .catch(error => {
                alert("Error en la petición: " + error);
            });
    }

    function agregarFilaATabla(titulo, fecha, nombreArchivo) {
        const tableBody = document.getElementById('tableBody');
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
            <td>${titulo}</td>
            <td>${fecha}</td>
            <td>
                <button class="action-button view" onclick="viewPDF('${nombreArchivo}')">
                    <ion-icon name="eye-outline"></ion-icon>
                </button>
                <button class="action-button delete" onclick="deleteRow(this)">
                    <ion-icon name="trash-outline"></ion-icon>
                </button>
            </td>
        `;

        if (tableBody.innerHTML.includes('No hay archivos')) {
            tableBody.innerHTML = '';
        }

        tableBody.appendChild(newRow);
    }


    function deleteRow(button) {
        if (confirm("¿Eliminar este registro?")) {
            const row = button.closest('tr');
            row.remove();

            const tableBody = document.getElementById('tableBody');
            if (tableBody.children.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3">No hay archivos registrados</td></tr>';
            }
        }
    }

    function viewPDF(filename) {
        alert(`Funcionalidad de vista previa para: ${filename}`);
        // Implementar lógica para visualizar PDF
    }
    function cargarTablaPDFs() {
        console.log("Llamando a /listar-pdfs...");
        $.get('/listar-pdfs', function (data) {
            console.log("Datos recibidos de /listar-pdfs:", data);
            const tbody = $('#tableBody');
            tbody.empty();

            if (data.results.length === 0) {
                tbody.append('<tr><td colspan="3">No hay archivos registrados</td></tr>');
                return;
            }

            data.results.forEach(function (doc) {
                const fila = `
                <tr>
                    <td>${doc.titulo}</td>
                    <td>${doc.fecha}</td>
                    <td class="actions-cell">
                        <button class="action-button view" onclick="viewPDF('${doc.pdf_url}')">
                            <ion-icon name="eye-outline"></ion-icon>
                        </button>
                        <button class="action-button consult" onclick="openChatModal('${doc.id}', '${doc.titulo.replace(/'/g, "\\'")}')">
                            <ion-icon name="chatbox-outline"></ion-icon>
                        </button>
                        <button class="action-button delete" onclick="deleteRow(this, '${doc.id}')">
                            <ion-icon name="trash-outline"></ion-icon>
                        </button>
                    </td>
                </tr>
            `;
                tbody.append(fila);
            });
        }).fail(function (err) {
            console.error("Error en /listar-pdfs:", err.responseText);
        });
    }

    // Llama a la función al cargar la página
    $(document).ready(function () {
        cargarTablaPDFs();
    });

    // Búsqueda en tiempo real
    document.getElementById('searchInput').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#tableBody tr');

        rows.forEach(row => {
            const title = row.cells[0].textContent.toLowerCase();
            row.style.display = title.includes(searchTerm) ? '' : 'none';
        });
    });
    $('#pdfForm').on('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        console.log("Enviando formulario con los siguientes datos:");
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }

        $.ajax({
            url: '/registrar-pdf',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                console.log("Respuesta exitosa del backend:", response);
                alert(response.mensaje);
                cargarTablaPDFs(); // refresca la tabla
                $('#pdfForm')[0].reset(); // limpia el formulario
            },
            error: function (xhr) {
                console.error("Error al registrar el documento:", xhr.responseText);
                alert("Error al registrar el documento: " + xhr.responseJSON?.mensaje || 'Error desconocido');
            }
        });
    });
</script>
{% endblock %}